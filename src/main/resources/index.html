<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Presentation Live Feedback</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
          integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3"
          crossorigin="anonymous">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/2.9.2/umd/popper.min.js"
            integrity="sha512-2rNj2KJ+D8s1ceNasTIex6z4HWyOnEYLVC3FigGOmyQCZc2eBXKgOxQmo3oKLHyfcj53uz4QMsRCWNbLd32Q1g=="
            crossorigin="anonymous"
            referrerpolicy="no-referrer"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.min.js"
            integrity="sha384-QJHtvGhmr9XOIpI6YVutG+2QOK9T+ZnN4kzFN1RtK3zEFEIsxhlmWl5/YESvpZ13"
            crossorigin="anonymous"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <style>
    .w-10 {
        width: 10% !important;
    }

    .mr-1 {
        margin-right: .3rem !important;
    }

    .ml-1 {
        margin-left: .3rem !important;
    }

    .reaction-emote {
        font-size: 21px;
    }

    .hidden {
        display: none;
    }

    .clickable {
        cursor: pointer;
    }

    #bottom-right-container {
        position: absolute;
        bottom: 0;
        right: 0;
        padding: 10px 20px 10px 10px;
        transition: all 0.1s ease-in-out;
        color: #6c757d;
    }

    #bottom-right-container:hover {
        color: #0066ff;
    }
    </style>
</head>
<body>

<a id="bottom-right-container"
   class="text-decoration-none"
   href="https://github.com/Skyball2000/presentation-live-feedback/tree/main"
   target="_blank">
    v${pom.version}
</a>

<div class="container">
    <table id="user-table" class="table table-hover hidden">
        <thead>
        <tr>
            <th scope="col" class="w-10">Status</th>
            <th scope="col">Name</th>
        </tr>
        </thead>
        <tbody id="user-entry-container"></tbody>
    </table>

    <div id="reaction-button-container" class="hidden"></div>
    <div id="other-user-actions-container" class="hidden">
        <button id="hand-raise-button" class="btn btn-primary">&#x270B;</button>
        <button id="adminClearAllHandRaise" class="btn btn-primary admin-only hidden">Clear all &#x270B;</button>
        <button id="adminClearAllEmotes" class="btn btn-primary admin-only hidden">Clear all Reactions</button>
        <button id="adminMessageToAllUsers" class="btn btn-primary admin-only hidden">&#x1F4E7; to all</button>
        <div id="adminReactionCounts" class="admin-only hidden"></div>
    </div>

    <div id="login-form">
        <br>
        <h3>Join a Session</h3>
        <div class="mb-3">
            <label for="inputUserName" class="form-label">Username</label>
            <input type="text" class="form-control" id="inputUserName">
        </div>
        <div class="mb-3">
            <label for="adminPasswordInput" class="form-label">Admin Password</label>
            <input type="password" class="form-control" id="adminPasswordInput">
            <div id="emailHelp" class="form-text">Optional. Allows for more actions to be taken.</div>
        </div>
        <div class="mb-3 form-check">
            <input type="checkbox" class="form-check-input" id="storeUsernameBetweenSessionsToggle">
            <label class="form-check-label" for="storeUsernameBetweenSessionsToggle">
                Store username between sessions
            </label>
        </div>
        <button id="join-session-button" class="btn btn-primary">Join Session</button>
    </div>
</div>

<button id="openGeneralModalButton" type="button" class="btn btn-primary hidden" data-bs-toggle="modal"
        data-bs-target="#generalModal">
    Launch demo modal
</button>

<div class="modal fade" id="generalModal" tabindex="-1" aria-labelledby="generalModalTitle" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="generalModalTitle">Modal title</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div id="generalModalContent" class="modal-body">
                No content here.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>


<script>
    function openModal(title, content) {
        let openGeneralModalButton = document.getElementById('openGeneralModalButton');
        let modalTitle = document.getElementById('generalModalTitle');
        let modalContent = document.getElementById('generalModalContent');

        modalTitle.innerText = title;
        modalContent.innerText = content;

        openGeneralModalButton.click();
    }

    function sendMessage(content) {
        let message = {
            content: content,
            from: username,
            admin: adminPassword
        };
        console.log('sent message: ' + JSON.stringify(message));
        socket.send(JSON.stringify(message));
    }

    function socketCallback(event) {
        console.log('Message from server: ' + event.data);
        let message = JSON.parse(event.data);
        if (message.to !== username && message.to !== 'ALL_USERS') return;
        if (message.content.type) {
            switch (message.content.type) {
                case "updateReactions":
                    updateReactionButtons(message.content.reactions);
                    break;
                case "updateUsers":
                    updateUserEntries(message.content.users);
                    break;
                case "adminConfirmation":
                    adminCorrect = message.content.isCorrect;
                    console.log('Admin password correct:', adminCorrect);
                    setAdminEnabled();
                    break;
                case "modal":
                    let title = message.content.title;
                    let content = message.content.message;
                    openModal(title, content);
                    break;
            }
        }
    }

    function initializeServerConnection() {
        adminCorrect = false;
        try {
            const headers = getResponseHeaders();

            if (!headers['websocket-address']) {
                openModal('Error', 'Server did not provide API endpoint.');
                setFormInputSessionActive();
                return;
            }

            let websocketAddress = headers['websocket-address'];

            /* the websocketAddress is only the port/path, so we need to add the hostname */
            let hostname = window.location.hostname;
            websocketAddress = 'ws://' + hostname + ':' + websocketAddress;
            console.log('Attempting connection to', websocketAddress);

            const socket = new WebSocket(websocketAddress);

            socket.addEventListener('open', function (event) {
                sendMessage('register');
            });

            socket.addEventListener('message', function (event) {
                socketCallback(event);
            });

            socket.addEventListener('close', function (event) {
                console.log('Socket closed.');
                setFormInputSessionActive();
                document.getElementById('adminPasswordInput').value = '';
                openModal('Session closed', 'Thank you for being part of the session. Until next time!');
            });

            setSessionActive();

            return socket;
        } catch (e) {
            console.log(e);
            openModal('Error', 'WebSocket API endpoint could not be reached under ' + window.location.href);
            setFormInputSessionActive();
        }

        return null;
    }

    function getResponseHeaders() {
        let req = new XMLHttpRequest();
        req.open('GET', document.location, false);
        req.send(null);
        let headers = req.getAllResponseHeaders().toLowerCase();
        return headers.split(/\n|\r|\r\n/g).reduce(function (a, b) {
            if (b.length) {
                let [key, value] = b.split(': ');
                a[key] = value;
            }
            return a;
        }, {});
    }

    function updateReactionButtons(reactions) {
        let container = document.getElementById('reaction-button-container');
        removeAllChildren(container);


        for (let reaction of reactions) {
            let symbol = reaction.emote;
            let name = reaction.name;
            let button = document.createElement('button');
            makeTooltip(button, name);
            button.type = 'button';
            button.className = 'btn btn-outline-primary mb-2 mr-1';
            button.innerText = symbol;
            button.addEventListener('click', function () {
                sendReaction(symbol, name);
            });
            container.appendChild(button);
        }

        updateTooltips();
        setAdminEnabled();
    }

    function updateUserEntries(users) {
        let container = document.getElementById('user-entry-container');
        for (let user of users) {
            let currentUsername = user.name;
            let reaction = user.reaction;
            let handRaisedIndex = user.handRaisedIndex;
            let reactionLastChanged = user.reactionLastChanged;

            let entry = container.querySelector('[data-username="' + currentUsername + '"]');
            if (entry) {
                entry.dataset.lastUpdated = reactionLastChanged;
                let element = entry.querySelector('.reaction-emote');
                element.firstChild.innerText = reaction.emote;
                let userNameElement = entry.querySelector('.username');

                removeAllChildren(userNameElement);

                let usernameHandRaisedElement = makeUsernameHandRaised(currentUsername, handRaisedIndex);
                userNameElement.appendChild(usernameHandRaisedElement);

                let sendMessageToUser = document.createElement('span');
                sendMessageToUser.className = 'ml-1 clickable admin-only hidden';
                sendMessageToUser.innerText = 'ðŸ“§';
                sendMessageToUser.addEventListener('click', function () {
                    let input = prompt('Enter message to send to ' + currentUsername);
                    if (input) {
                        let message = {type: 'adminMessage', 'to': currentUsername, 'message': input, 'from': username};
                        sendMessage(message);
                    }
                });
                userNameElement.appendChild(sendMessageToUser);
            } else {
                entry = document.createElement('tr');
                entry.dataset.username = currentUsername;
                entry.dataset.lastUpdated = reactionLastChanged;

                let emote = document.createElement('td');
                emote.className = 'reaction-emote';
                let emoteElement = document.createElement('span');
                emoteElement.innerText = reaction.emote;
                emote.appendChild(emoteElement);
                makeTooltip(emoteElement, fromNow(reactionLastChanged), 'right');
                emote.addEventListener('mouseenter', function () {
                    let asInt = parseInt(entry.dataset.lastUpdated);
                    makeTooltip(emoteElement, fromNow(asInt), 'right');
                });

                let usernameCell = document.createElement('td');
                usernameCell.className = 'username';
                let usernameHandRaisedElement = makeUsernameHandRaised(currentUsername, handRaisedIndex);
                usernameCell.appendChild(usernameHandRaisedElement);

                let sendMessageToUser = document.createElement('span');
                sendMessageToUser.className = 'ml-1 clickable admin-only hidden';
                sendMessageToUser.innerText = String.fromCodePoint(0x1F4E7);
                sendMessageToUser.addEventListener('click', function () {
                    let input = prompt('Enter message to send to ' + currentUsername);
                    if (input) {
                        let message = {type: 'adminMessage', 'to': currentUsername, 'message': input, 'from': username};
                        sendMessage(message);
                    }
                });
                usernameCell.appendChild(sendMessageToUser);

                entry.appendChild(emote);
                entry.appendChild(usernameCell);
                container.appendChild(entry);
            }

            let entries = Array.from(container.querySelectorAll('tr'));
            entries.sort(function (a, b) {
                return b.dataset.lastUpdated - a.dataset.lastUpdated;
            });
            removeAllChildren(container);
            for (let entry of entries) {
                container.appendChild(entry);
            }

            updateTooltips();
            setAdminEnabled();
        }


        let reactionCountsMap = new Map();

        let entries = Array.from(container.querySelectorAll('tr'));
        for (let i = 0; i < entries.length; i++) {
            let reactionColumn = entries[i].querySelector('.reaction-emote');
            let reaction = reactionColumn.firstChild.innerText;
            if (reactionCountsMap.has(reaction)) {
                reactionCountsMap.set(reaction, reactionCountsMap.get(reaction) + 1);
            } else {
                reactionCountsMap.set(reaction, 1);
            }
        }

        let sortedReactionCounts = Array.from(reactionCountsMap).sort((a, b) => b[1] - a[1]);
        let adminReactionCountsContainer = document.getElementById('adminReactionCounts');
        removeAllChildren(adminReactionCountsContainer);
        for (let [reaction, count] of sortedReactionCounts) {
            let badge = document.createElement('span');
            badge.className = 'badge bg-secondary text-white m-2 p-2 fs-6';
            badge.innerText = count + ' ' + reaction;
            adminReactionCountsContainer.appendChild(badge);
        }
    }

    function makeUsernameHandRaised(username, handRaiseIndex) {
        let usernameElement = document.createElement('span');
        if (handRaiseIndex <= 0) {
            usernameElement.innerText = username;
        } else {
            usernameElement.innerText = username + ' ';
            let handRaiseElement = document.createElement('span');
            handRaiseElement.classList.add('hand-raise');
            handRaiseElement.classList.add('clickable');
            let handEmoji = '\u270B';
            handRaiseElement.innerText = handEmoji + ' (' + handRaiseIndex + ')';
            handRaiseElement.addEventListener('click', function () {
                let message = {type: 'adminRemoveHandRaise', 'removeName': username};
                sendMessage(message);
            });
            usernameElement.appendChild(handRaiseElement);
        }
        return usernameElement;
    }

    /**
     * Human readable elapsed or remaining time (example: 3 minutes ago)
     * @param  {Date|Number|String} date A Date object, timestamp or string parsable with Date.parse()
     * @return {string} Human readable elapsed or remaining time
     * @author github.com/victornpb
     * @see https://stackoverflow.com/a/67338038/938822
     */
    function fromNow(date) {
        const SECOND = 1000;
        const MINUTE = 60 * SECOND;
        const HOUR = 60 * MINUTE;
        const DAY = 24 * HOUR;
        const WEEK = 7 * DAY;
        const MONTH = 30 * DAY;
        const YEAR = 365 * DAY;
        const units = [
            {
                max: 5 * SECOND,
                divisor: 1,
                past1: 'just now',
                pastN: 'just now',
                future1: 'just now',
                futureN: 'just now'
            },
            {
                max: MINUTE,
                divisor: SECOND,
                past1: 'a second ago',
                pastN: '# seconds ago',
                future1: 'in a second',
                futureN: 'in # seconds'
            },
            {
                max: HOUR,
                divisor: MINUTE,
                past1: 'a minute ago',
                pastN: '# minutes ago',
                future1: 'in a minute',
                futureN: 'in # minutes'
            },
            {
                max: DAY,
                divisor: HOUR,
                past1: 'an hour ago',
                pastN: '# hours ago',
                future1: 'in an hour',
                futureN: 'in # hours'
            },
            {
                max: WEEK,
                divisor: DAY,
                past1: 'yesterday',
                pastN: '# days ago',
                future1: 'tomorrow',
                futureN: 'in # days'
            },
            {
                max: 4 * WEEK,
                divisor: WEEK,
                past1: 'last week',
                pastN: '# weeks ago',
                future1: 'in a week',
                futureN: 'in # weeks'
            },
            {
                max: YEAR,
                divisor: MONTH,
                past1: 'last month',
                pastN: '# months ago',
                future1: 'in a month',
                futureN: 'in # months'
            },
            {
                max: 100 * YEAR,
                divisor: YEAR,
                past1: 'last year',
                pastN: '# years ago',
                future1: 'in a year',
                futureN: 'in # years'
            },
            {
                max: 1000 * YEAR,
                divisor: 100 * YEAR,
                past1: 'last century',
                pastN: '# centuries ago',
                future1: 'in a century',
                futureN: 'in # centuries'
            },
            {
                max: Infinity,
                divisor: 1000 * YEAR,
                past1: 'last millennium',
                pastN: '# millennia ago',
                future1: 'in a millennium',
                futureN: 'in # millennia'
            },
        ];
        const diff = Date.now() - (typeof date === 'object' ? date : new Date(date)).getTime();
        const diffAbs = Math.abs(diff);
        for (const unit of units) {
            if (diffAbs < unit.max) {
                const isFuture = diff < 0;
                const x = Math.round(Math.abs(diff) / unit.divisor);
                if (x <= 1) return isFuture ? unit.future1 : unit.past1;
                return (isFuture ? unit.futureN : unit.pastN).replace('#', x);
            }
        }
    };

    function createTooltip(text, tooltipText) {
        let tooltip = document.createElement('span');
        makeTooltip(tooltip, tooltipText);
        tooltip.innerText = text;
        return tooltip;
    }

    function makeTooltip(element, tooltipText, direction = 'bottom') {
        element.setAttribute('data-bs-toggle', 'tooltip');
        element.setAttribute('data-bs-placement', direction);
        element.setAttribute('data-bs-original-title', tooltipText);
    }

    function updateTooltips() {
        let tooltips = document.querySelectorAll('.tooltip');
        for (let tooltip of tooltips) {
            tooltip.remove();
        }
        [...document.querySelectorAll('[data-bs-toggle="tooltip"]')].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl));
    }

    function removeAllChildren(element) {
        while (element.firstChild) {
            element.removeChild(element.firstChild);
        }
    }

    function sendReaction(symbol, reactionName) {
        let message = {
            type: 'reaction',
            emote: symbol,
            reactionName: reactionName
        };
        sendMessage(message);
    }

    let initializeSessionButtonActive = true;

    function initialize() {
        adminCorrect = false;
        let joinSessionButton = document.getElementById('join-session-button');
        joinSessionButton.addEventListener('click', function () {
            if (!initializeSessionButtonActive) return;
            initializeSessionButtonActive = false;
            joinSessionButton.classList.remove('btn-primary');
            joinSessionButton.classList.add('btn-secondary');
            joinSessionButton.setAttribute('disabled', 'disabled');
            username = document.getElementById('inputUserName').value;
            adminPassword = document.getElementById('adminPasswordInput').value;
            if (username.length === 0) {
                openModal('Error', 'Please enter a valid username');
                setFormInputSessionActive();
                return;
            }
            socket = initializeServerConnection();

            if (adminPassword.length > 0) {
                setTimeout(function () {
                    sendMessage({type: 'isAdminPasswordCorrect'});
                }, 1000);
            }

            let storeUsernameBetweenSessionsToggle = document.getElementById('storeUsernameBetweenSessionsToggle');
            if (storeUsernameBetweenSessionsToggle.checked) {
                localStorage.setItem('username', username);
            } else {
                localStorage.removeItem('username');
            }

            let userList = document.getElementById('user-entry-container');
            removeAllChildren(userList);
        });

        document.getElementById('adminClearAllHandRaise').addEventListener('click', function () {
            sendMessage({type: 'clearAllHandRaise'});
        });

        document.getElementById('adminClearAllEmotes').addEventListener('click', function () {
            sendMessage({type: 'clearAllReactions'});
        });

        document.getElementById('adminMessageToAllUsers').addEventListener('click', function () {
            let input = prompt('Enter message to send to all users');
            if (input) {
                let message = {type: 'adminMessage', 'to': 'ALL_USERS', 'message': input, 'from': username};
                sendMessage(message);
            }
        });

        document.getElementById('hand-raise-button').addEventListener('click', function () {
            sendMessage({type: 'handRaiseToggle'});
        });
    }

    function setFormInputSessionActive() {
        initializeSessionButtonActive = true;
        let joinSessionButton = document.getElementById('join-session-button');
        joinSessionButton.classList.remove('btn-secondary');
        joinSessionButton.classList.add('btn-primary');
        joinSessionButton.removeAttribute('disabled');

        let loginForm = document.getElementById('login-form');
        loginForm.classList.remove('hidden');

        let reactionButtonContainer = document.getElementById('reaction-button-container');
        let otherUserActionsContainer = document.getElementById('other-user-actions-container');
        let userTable = document.getElementById('user-table');
        reactionButtonContainer.classList.add('hidden');
        otherUserActionsContainer.classList.add('hidden');
        userTable.classList.add('hidden');
    }

    function setSessionActive() {
        initializeSessionButtonActive = false;
        let loginForm = document.getElementById('login-form');
        loginForm.classList.add('hidden');

        let reactionButtonContainer = document.getElementById('reaction-button-container');
        let otherUserActionsContainer = document.getElementById('other-user-actions-container');
        let userTable = document.getElementById('user-table');
        reactionButtonContainer.classList.remove('hidden');
        otherUserActionsContainer.classList.remove('hidden');
        userTable.classList.remove('hidden');
    }

    function setAdminEnabled() {
        let adminElements = document.getElementsByClassName('admin-only');
        for (let i = 0; i < adminElements.length; i++) {
            if (adminCorrect) {
                adminElements[i].classList.remove('hidden');
            } else {
                adminElements[i].classList.add('hidden');
            }
        }
    }

    let socket;
    let adminPassword = 'NO_PASSWORD';
    let adminCorrect = false;
    let username;
    let localStorageUsername = localStorage.getItem('username');
    if (localStorageUsername) {
        username = localStorageUsername;
        document.getElementById('inputUserName').value = username;
        document.getElementById('storeUsernameBetweenSessionsToggle').checked = true;
    } else {
        username = 'anonymous user ' + Math.floor(Math.random() * 100);
    }

    initialize();
</script>

</body>
</html>